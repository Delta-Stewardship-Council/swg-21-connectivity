---
title: "nutrient_diagnostics"
output: html_document
date: "2022-09-30"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#load libraries 
```{r}
library(readr)
library(dplyr)
library(stats)
library(tidyr)
library(ggplot2)
library(ggpubr)
library(lubridate)
library(signal)
library(dataRetrieval)
#remotes::install_github("USGS-R/dataRetrieval")
```

#read in data
```{r}
explore <- read.csv("data_model/model_chla_nuts_combined.csv")

inun <- read.csv("data_model/inundation_with_doy1998.csv")

dat_na <- data.frame(sapply(X = explore, FUN = function(x) sum(is.na(x))))
```
#remove nutrients if not paired with chlorophyll 
#add Yolo, Cache, Rio Vista, and Sac R regions to df 
```{r}

new_dat <- explore[,c(2:5, 7,10,12,14,15,18)]

new_dat_chl <- new_dat[!is.na(new_dat$chlorophyll),]

sum(is.na(new_dat_chl$diss_nitrate_nitrite == TRUE))

new_dat_chl$date <- as.POSIXct(new_dat_chl$date, format = "%Y-%m-%d")

unique(new_dat_chl$station_wq_chl)

#add regions to df

regions <- new_dat_chl %>%
  mutate(region = case_when(
        latitude>=38.13&latitude<= 38.22 ~ 'RV',
        latitude>=38.221&latitude<= 38.35 ~ 'CSC',
        latitude>=38.3501&longitude<=-121.568291 ~ 'Yolo',
        longitude>=-121.5727 ~ 'Sac'))

regions <- regions %>% 
  drop_na(region)
```
#subset data >= WY 2009  
```{r}
regions_WY09 <- subset(regions, date>="2008-10-01")
```

#add inundation to regions df to explore nut. #concentrations during inundated and non-inundated periods
#nutrients lowest during Yolo Bypass inundation except in the Sac. R.

```{r}
regions_WY09$date <- as.Date(regions_WY09$date)

inun$date <- as.Date(inun$date)

inun_nuts <- merge(regions_WY09, inun, by="date", all.x="TRUE")

# identify NO3 + NO2 concentration during bypass inundation 
#red is inun., black is non-inun.

inun_nuts$inundation <- as.character(inun_nuts$inundation)

#NO3+NO2
ggplot(inun_nuts, aes(date, diss_nitrate_nitrite)) + 
  geom_point(color=ifelse(inun_nuts$inundation>0, 'red', 'black')) +
  xlim(c(as.Date('2013-01-01'), as.Date('2020-12-31'))) +
  facet_wrap(~region, scales = "fixed") +
  labs(x = 'Date', y = 'NO3 + NO2 (mg/L)') +
  ggtitle("diss. NO3 + NO2")

#NH4

ggplot(inun_nuts, aes(date, diss_ammonia)) + 
  geom_point(color=ifelse(inun_nuts$inundation>0, 'red', 'black')) +
  xlim(c(as.Date('2013-01-01'), as.Date('2020-12-31'))) +
  facet_wrap(~region, scales = "fixed") +
  labs(x = 'Date', y = 'NH4 + NH3 (mg/L)') +
  ggtitle("diss. NH4 + NH3")

#ortho-p

ggplot(inun_nuts, aes(date, diss_orthophos)) + 
  geom_point(color=ifelse(inun_nuts$inundation>0, 'red', 'black')) +
  xlim(c(as.Date('2013-01-01'), as.Date('2020-12-31'))) +
  facet_wrap(~region, scales = "fixed") +
  labs(x = 'Date', y = 'orthophos. (mg/L)') +
  ggtitle("diss. orthophos.")

#DIN
ggplot(inun_nuts, aes(date, din)) + 
  geom_point(color=ifelse(inun_nuts$inundation>0, 'red', 'black')) +
  xlim(c(as.Date('2013-01-01'), as.Date('2020-12-31'))) +
  facet_wrap(~region, scales = "fixed") +
  labs(x = 'Date', y = 'DIN (mg/L)') +
  ggtitle("diss. inorganic nitrogen")
```
#explore nutrient - chlorophyll relationship, relationship is not strong
```{r}
#NO3 + NO2
ggplot(inun_nuts, aes(diss_nitrate_nitrite, chlorophyll)) + 
  geom_point(color=ifelse(inun_nuts$inundation>0, 'red', 'black')) +
  facet_wrap(~region, scales = "fixed") +
  labs(x = 'NO3 + NO2 (mg/L)', y = 'Chl-a (ug/L') +
  ggtitle("diss. NO3 + NO2 - Chl-a") +
  geom_smooth(method='lm', se = FALSE)

#NH4+NH3
ggplot(inun_nuts, aes(diss_ammonia, chlorophyll)) + 
  geom_point(color=ifelse(inun_nuts$inundation>0, 'red', 'black')) +
  facet_wrap(~region, scales = "fixed") +
  labs(x = 'NH4 + NH3 (mg/L)', y = 'Chl-a (ug/L') +
  ggtitle("diss. NH4 + NH3 - Chl-a") +
  geom_smooth(method='lm', se = FALSE)

#DIN
ggplot(inun_nuts, aes(din, chlorophyll)) + 
  geom_point(color=ifelse(inun_nuts$inundation>0, 'red', 'black')) +
  facet_wrap(~region, scales = "fixed") +
  labs(x = 'DIN (mg/L)', y = 'Chl-a (ug/L') +
  ggtitle("DIN - Chl-a") +
  geom_smooth(method='lm', se = FALSE)

#orthophos.
ggplot(inun_nuts, aes(diss_orthophos, chlorophyll)) + 
  geom_point(color=ifelse(inun_nuts$inundation>0, 'red', 'black')) +
  facet_wrap(~region, scales = "fixed") +
  labs(x = 'orthophos. (mg/L)', y = 'Chl-a (ug/L') +
  ggtitle("diss. orthophos. - Chl-a") +
  geom_smooth(method='lm', se = FALSE)

```
#nutrient relationship across with Sac R and Yolo flows across regions; 
```{r}
#NH4 + NO3
ggplot(inun_nuts, aes(x=flow_yolo, y=diss_ammonia, color=region, shape=region)) +
  geom_point() + 
  geom_smooth(method=lm, se = FALSE, aes(fill=region)) +
  labs(x = 'Yolo dayflow (cfs)', y = 'NH4 + NH3 (mg/L)') +
  ggtitle('Yolo flow - diss. NH4 + NH3')

ggplot(inun_nuts, aes(x=SAC, y=diss_ammonia, color=region, shape=region)) +
  geom_point() + 
  geom_smooth(method=lm, se = FALSE, aes(fill=region)) +
   labs(x = 'Sac R a Verona (cfs)', y = 'NH4 + NH3 (mg/L)') +
  ggtitle('Sac R flow - diss. NH4 + NH3')

#N03 + N02
ggplot(inun_nuts, aes(x=flow_yolo, y=diss_nitrate_nitrite, color=region, shape=region)) +
  geom_point() + 
  geom_smooth(method=lm, se = FALSE, aes(fill=region)) +
  labs(x = 'Yolo dayflow (cfs)', y = 'NO3 + NO2 (mg/L)') +
  ggtitle('Yolo flow - diss. NO3 + NO2')

ggplot(inun_nuts, aes(x=SAC, y=diss_nitrate_nitrite, color=region, shape=region)) +
  geom_point() + 
  geom_smooth(method=lm, se = FALSE, aes(fill=region)) +
   labs(x = 'Sac R a Verona (cfs)', y = 'NO3 + NO2 (mg/L)') +
  ggtitle('Sac R flow - diss. NO3 + NO2')

#DIN
ggplot(inun_nuts, aes(x=flow_yolo, y=din, color=region, shape=region)) +
  geom_point() + 
  geom_smooth(method=lm, se = FALSE, aes(fill=region)) +
  labs(x = 'Yolo dayflow (cfs)', y = 'DIN (mg/L)') +
  ggtitle('Yolo flow - DIN')

ggplot(inun_nuts, aes(x=SAC, y=din, color=region, shape=region)) +
  geom_point() + 
  geom_smooth(method=lm, se = FALSE, aes(fill=region)) +
   labs(x = 'Sac R a Verona (cfs)', y = 'DIN (mg/L)') +
  ggtitle('Sac R flow - DIN')

#orthophos
ggplot(inun_nuts, aes(x=flow_yolo, y=diss_orthophos, color=region, shape=region)) +
  geom_point() + 
  geom_smooth(method=lm, se = FALSE, aes(fill=region)) +
  labs(x = 'Yolo dayflow (cfs)', y = 'orthophos (mg/L)') +
  ggtitle('Yolo flow - diss. orthophos.')

ggplot(inun_nuts, aes(x=SAC, y=diss_orthophos, color=region, shape=region)) +
  geom_point() + 
  geom_smooth(method=lm, se = FALSE, aes(fill=region)) +
   labs(x = 'Sac R a Verona (cfs)', y = 'orthophos (mg/L)') +
  ggtitle('Sac R flow - diss. orthophos')

```

